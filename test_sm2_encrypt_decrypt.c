#include "sm2_encrypt_decrypt.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>


/**
 * 使用《GMT 0003.5-2012 SM2椭圆曲线公钥密码算法第5部分：参数定义》附录C的加解密示例数据来验证
 * 待加密消息：encryption standard，对应ASCII码的16进制表示：656E6372797074696F6E207374616E64617264
 * 私钥： 3945208F 7B2144B1 3F36E38A C6D39F95 88939369 2860B51A 42FB81EF 4DF7C5B8
 * 公钥x：09F9DF31 1E5421A1 50DD7D16 1E4BC5C6 72179FAD 1833FC07 6BB08FF3 56F35020
 * 公钥y：CCEA490C E26775A5 2DC6EA71 8CC1AA60 0AED05FB F35E084A 6632F607 2DA9AD13
 * 
 * 密文
 * C1 x:04EBFC718E8D1798620432268E77FEB6415E2EDE0E073C0F4F640ECD2E149A73
 * C1 y:E858F9D81E5430A57B36DAAB8F950A3C64E6EE6A63094D99283AFF767E124DF0
 * C3:59983C18F809E262923C53AEC295D30383B54E39D609D160AFCB1908D0BD8766
 * C2:21886CA989CA9C7D58087307CA93092D651EFA
 * 
 */
static const unsigned char s_plain_text[] = {
    0x65, 0x6E, 0x63, 0x72, 0x79, 0x70, 0x74, 0x69, 0x6F, 
    0x6E, 0x20, 0x73, 0x74, 0x61, 0x6E, 0x64, 0x61, 0x72,
    0x64
};

static const unsigned char s_prikey_buff[] = {
    0x39, 0x45, 0x20, 0x8F, 0x7B, 0x21, 0x44, 0xB1, 0x3F, 0x36, 0xE3, 0x8A, 0xC6, 0xD3, 0x9F, 0x95, 
    0x88, 0x93, 0x93, 0x69, 0x28, 0x60, 0xB5, 0x1A, 0x42, 0xFB, 0x81, 0xEF, 0x4D, 0xF7, 0xC5, 0xB8
};

static const unsigned char s_pubkey_buff[] = {
    /* 04：非压缩格式 */
    0x04, 
    /* 公钥x */
    0x09, 0xF9, 0xDF, 0x31, 0x1E, 0x54, 0x21, 0xA1, 0x50, 0xDD, 0x7D, 0x16, 0x1E, 0x4B, 0xC5, 0xC6, 
    0x72, 0x17, 0x9F, 0xAD, 0x18, 0x33, 0xFC, 0x07, 0x6B, 0xB0, 0x8F, 0xF3, 0x56, 0xF3, 0x50, 0x20,
    /* 公钥y */
    0xCC, 0xEA, 0x49, 0x0C, 0xE2, 0x67, 0x75, 0xA5, 0x2D, 0xC6, 0xEA, 0x71, 0x8C, 0xC1, 0xAA, 0x60, 
    0x0A, 0xED, 0x05, 0xFB, 0xF3, 0x5E, 0x08, 0x4A, 0x66, 0x32, 0xF6, 0x07, 0x2D, 0xA9, 0xAD, 0x13
};

/* C1 || C3 || C2, ASN.1 DER编码*/
static const unsigned char s_cipher_text[] = {
    0x30, 0x7c, 
    /* C1: x*/
    0x02, 0x20, 
    0x04, 0xEB, 0xFC, 0x71, 0x8E, 0x8D, 0x17, 0x98, 0x62, 0x04, 0x32, 0x26, 0x8E, 0x77, 0xFE, 0xB6, 
    0x41, 0x5E, 0x2E, 0xDE, 0x0E, 0x07, 0x3C, 0x0F, 0x4F, 0x64, 0x0E, 0xCD, 0x2E, 0x14, 0x9A, 0x73, 
    /* C1: y*/
    0x02, 0x21, 
    0x00, 0xE8, 0x58, 0xF9, 0xD8, 0x1E, 0x54, 0x30, 0xA5, 0x7B, 0x36, 0xDA, 0xAB, 0x8F, 0x95, 0x0A, 
    0x3C, 0x64, 0xE6, 0xEE, 0x6A, 0x63, 0x09, 0x4D, 0x99, 0x28, 0x3A, 0xFF, 0x76, 0x7E, 0x12, 0x4D, 
    0xF0, 
    /* C3: hash */
    0x04, 0x20, 
    0x59, 0x98, 0x3C, 0x18, 0xF8, 0x09, 0xE2, 0x62, 0x92, 0x3C, 0x53, 0xAE, 0xC2, 0x95, 0xD3, 0x03, 
    0x83, 0xB5, 0x4E, 0x39, 0xD6, 0x09, 0xD1, 0x60, 0xAF, 0xCB, 0x19, 0x08, 0xD0, 0xBD, 0x87, 0x66, 
    /* C2: cipher text*/
    0x04, 0x13, 
    0x21, 0x88, 0x6C, 0xA9, 0x89, 0xCA, 0x9C, 0x7D, 0x58, 0x08, 0x73, 0x07, 0xCA, 0x93, 0x09, 0x2D, 
    0x65, 0x1E, 0xFA
};

void test_decrypt_data_in_standard(void) 
{
    size_t plain_text_len = sizeof(s_plain_text);
    unsigned char *plain_text = malloc(sizeof(plain_text_len));
    
    if (!sm2_decrypt(s_prikey_buff, sizeof(s_prikey_buff),
        s_cipher_text, sizeof(s_cipher_text), plain_text, &plain_text_len)) {
        printf("test_decrypt_data_in_standard:sm2_decrypt() error\n");
        goto end;
    }
    if ((plain_text_len != sizeof(s_plain_text))
        || (memcmp(plain_text, s_plain_text, plain_text_len) != 0)) {
        printf("test_decrypt_data_in_standard() failed\n");
    } else {
        printf("test_decrypt_data_in_standard() passed\n");
    }
end:
    if (plain_text) {
        free(plain_text);
    }
}

void test_encrypt_decrypt(void)
{
    const unsigned char text[] = "hello, sm2";
    unsigned char plain_text[1024];
    unsigned char cipher_text[1024];
    size_t plain_text_len = sizeof(plain_text);
    size_t cipher_text_len = sizeof(s_cipher_text);
    if (!sm2_encrypt(s_pubkey_buff, sizeof(s_pubkey_buff),
        text, sizeof(text), cipher_text, &cipher_text_len)) {
        printf("sm2_encrypt error\n");
        return;
    }
  
    if (!sm2_decrypt(s_prikey_buff, sizeof(s_prikey_buff),
        cipher_text, cipher_text_len, plain_text, &plain_text_len)) {
        printf("sm2_decrypt error");
        return;
    }
    if ((plain_text_len != sizeof(text)) || (memcmp(plain_text, text, plain_text_len) != 0)) {
        printf("test_encrypt_decrypt() failed\n");
    } else {
        printf("test_encrypt_decrypt() passed\n");
    }

}


int main(int argc, char **argv) 
{
    test_decrypt_data_in_standard();
    test_encrypt_decrypt();
    return 0;
}